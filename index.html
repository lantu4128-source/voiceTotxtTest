<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>è¯­éŸ³ç¬”è®° (è·¨è®¾å¤‡åŒæ­¥ç‰ˆ)</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://unpkg.com/peerjs@1.5.4/dist/peerjs.min.js"></script>
    <style>
        :root {
            --bg-color: #030610;
            --accent-color: #00ffc8;
            --text-color: #ffffff;
            --panel-bg: rgba(13, 22, 40, 0.8);
            --secondary-color: #4a5568;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body {
            background-color: var(--bg-color);
            color: var(--text-color);
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            margin: 0;
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* Header */
        header {
            padding: 15px;
            text-align: center;
            border-bottom: 1px solid rgba(0, 255, 200, 0.2);
            background: rgba(0, 0, 0, 0.2);
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 10;
        }

        header h2 { margin: 0; font-size: 18px; font-weight: 400; letter-spacing: 1px; color: var(--accent-color); }
        
        .icon-btn {
            background: none; border: none; font-size: 20px; cursor: pointer; color: var(--accent-color);
            padding: 5px;
        }
        
        .connection-status {
            font-size: 12px;
            color: #666;
            margin-left: 8px;
        }
        
        .connection-status.connected {
            color: var(--accent-color);
        }

        /* Transcript Area */
        #transcript {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 15px;
            scroll-behavior: smooth;
        }

        .msg-row {
            display: flex;
            align-items: flex-start;
            gap: 10px;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .msg {
            flex: 1;
            background: rgba(0, 255, 200, 0.05);
            border-left: 3px solid var(--accent-color);
            padding: 12px;
            border-radius: 4px;
            font-size: 16px;
            line-height: 1.5;
            word-break: break-all;
        }

        .msg.local {
            border-left-color: #bd93f9;
            background: rgba(189, 147, 249, 0.05);
        }

        .msg.interim {
            opacity: 0.6;
            border-left-color: #666;
            background: rgba(255, 255, 255, 0.02);
        }

        .copy-btn {
            background: transparent;
            border: 1px solid var(--accent-color);
            color: var(--accent-color);
            border-radius: 4px;
            padding: 6px 12px;
            font-size: 12px;
            cursor: pointer;
            white-space: nowrap;
            align-self: center;
        }

        .copy-btn:active {
            background: var(--accent-color);
            color: black;
        }

        /* Controls */
        #controls {
            height: 180px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background: var(--panel-bg);
            border-top: 1px solid rgba(0, 255, 200, 0.2);
            position: relative;
            z-index: 10;
        }

        #mic-btn {
            width: 72px;
            height: 72px;
            border-radius: 50%;
            background: rgba(0, 255, 200, 0.1);
            border: 2px solid var(--accent-color);
            color: var(--accent-color);
            font-size: 32px;
            cursor: pointer;
            display: flex;
            justify-content: center;
            align-items: center;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 0 15px rgba(0, 255, 200, 0.2);
            margin-bottom: 10px;
        }

        #mic-btn.recording {
            background: var(--accent-color);
            color: #000;
            transform: scale(1.1);
            box-shadow: 0 0 30px rgba(0, 255, 200, 0.6);
            animation: pulse 1.5s infinite;
        }
        
        #mic-btn.disabled {
            border-color: #666;
            color: #666;
            background: rgba(255, 255, 255, 0.05);
            box-shadow: none;
            cursor: not-allowed;
        }

        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(0, 255, 200, 0.7); }
            70% { box-shadow: 0 0 0 20px rgba(0, 255, 200, 0); }
            100% { box-shadow: 0 0 0 0 rgba(0, 255, 200, 0); }
        }

        #status {
            margin-bottom: 8px;
            font-size: 14px;
            color: var(--accent-color);
            opacity: 0.8;
            letter-spacing: 1px;
            text-align: center;
            height: 20px;
        }

        #device-role {
            font-size: 12px;
            color: #888;
            margin-bottom: 15px;
            background: rgba(255,255,255,0.1);
            padding: 4px 12px;
            border-radius: 12px;
        }

        #tips {
            position: absolute;
            bottom: 10px;
            font-size: 10px;
            color: #666;
            text-align: center;
            width: 100%;
        }

        /* QR Modal */
        #qr-modal {
            display: none;
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.9);
            z-index: 100;
            justify-content: center;
            align-items: center;
            flex-direction: column;
        }
        
        #qrcode {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .close-btn {
            border: 1px solid white;
            color: white;
            background: transparent;
            padding: 8px 24px;
            border-radius: 20px;
            cursor: pointer;
        }
    </style>
</head>
<body>

<header>
    <div style="display:flex; align-items:center;">
        <button class="icon-btn" id="qr-btn" title="æ˜¾ç¤ºäºŒç»´ç ">ğŸ“±</button>
        <span id="conn-status" class="connection-status">ç­‰å¾…è¿æ¥...</span>
    </div>
    <h2>VOICE NOTE</h2>
    <button class="icon-btn" id="clear-btn" title="æ¸…ç©ºè®°å½•">ğŸ—‘ï¸</button>
</header>

<div id="transcript">
    <!-- Messages will appear here -->
    <div style="text-align:center; color:#666; padding-top:50px; font-size:14px;" id="welcome-msg">
        ç”µè„‘ç«¯ï¼šç‚¹å‡»å·¦ä¸Šè§’æ‰‹æœºå›¾æ ‡è·å–äºŒç»´ç <br>
        æ‰‹æœºç«¯ï¼šæ‰«ç è¿æ¥åå¼€å§‹è¯´è¯
    </div>
</div>

<div id="controls">
    <div id="device-role">æ­£åœ¨åˆå§‹åŒ–...</div>
    <div id="status">å‡†å¤‡å°±ç»ª</div>
    <button id="mic-btn">ğŸ¤</button>
    <div id="tips">æ¨èä½¿ç”¨ Chrome / Safari / Edge</div>
</div>

<div id="qr-modal">
    <div id="qrcode"></div>
    <div style="color: white; margin: 10px 0 20px; font-size: 14px; text-align: center;">
        æ‰‹æœºæ‰«ç è¿æ¥æ­¤ç”µè„‘<br>
        <span style="font-size:12px; opacity:0.7;">(è¯·ç¡®ä¿ç½‘ç»œé€šç•…)</span>
    </div>
    <button class="close-btn" onclick="document.getElementById('qr-modal').style.display='none'">å…³é—­</button>
</div>

<script>
    // --- UI Elements ---
    const micBtn = document.getElementById('mic-btn');
    const statusText = document.getElementById('status');
    const transcriptDiv = document.getElementById('transcript');
    const tipsText = document.getElementById('tips');
    const qrBtn = document.getElementById('qr-btn');
    const connStatus = document.getElementById('conn-status');
    const roleLabel = document.getElementById('device-role');
    const clearBtn = document.getElementById('clear-btn');
    const welcomeMsg = document.getElementById('welcome-msg');

    // --- State ---
    let isRecording = false;
    let recognition;
    let peer;
    let conn;
    let myPeerId;
    let targetPeerId;
    
    // Parse URL params
    const urlParams = new URLSearchParams(window.location.search);
    targetPeerId = urlParams.get('host');

    // --- Role Setup ---
    if (targetPeerId) {
        // Client Mode (Mobile)
        roleLabel.textContent = "å½“å‰è®¾å¤‡: è¯­éŸ³è¾“å…¥ç«¯ (æ‰‹æœº)";
        micBtn.style.display = 'flex';
        qrBtn.style.display = 'none'; // Clients don't need to show QR
        welcomeMsg.style.display = 'none';
    } else {
        // Host Mode (PC)
        roleLabel.textContent = "å½“å‰è®¾å¤‡: æ¥æ”¶æ˜¾ç¤ºç«¯ (ç”µè„‘)";
        micBtn.style.opacity = '0.5'; // Optional for PC
        welcomeMsg.style.display = 'block';
    }

    // --- PeerJS / WebRTC Sync ---
    function initPeer() {
        peer = new Peer(null, {
            debug: 2
        });

        peer.on('open', (id) => {
            myPeerId = id;
            console.log('My Peer ID:', id);
            
            if (targetPeerId) {
                connectToHost(targetPeerId);
            } else {
                connStatus.textContent = "ç­‰å¾…æ‰‹æœºè¿æ¥...";
            }
        });

        // Handle incoming connections (Host logic)
        peer.on('connection', (c) => {
            conn = c;
            setupConnection();
            connStatus.textContent = "å·²è¿æ¥æ‰‹æœº";
            connStatus.classList.add('connected');
            welcomeMsg.style.display = 'none';
            statusText.textContent = "æ‰‹æœºç«¯å·²è¿æ¥ï¼Œè¯·è¯´è¯";
        });
        
        peer.on('error', (err) => {
            console.error(err);
            connStatus.textContent = "è¿æ¥æœåŠ¡é”™è¯¯";
            tipsText.textContent = "æ— æ³•è¿æ¥åˆ°åŒæ­¥æœåŠ¡ï¼Œè¯·åˆ·æ–°é‡è¯•";
        });
    }

    function connectToHost(id) {
        connStatus.textContent = "æ­£åœ¨è¿æ¥ç”µè„‘...";
        conn = peer.connect(id);
        setupConnection();
    }

    function setupConnection() {
        if (!conn) return;

        conn.on('open', () => {
            console.log("Connected to peer");
            connStatus.textContent = "å·²è¿æ¥åŒæ­¥";
            connStatus.classList.add('connected');
            if (targetPeerId) {
                // We are client
                statusText.textContent = "å·²è¿æ¥ï¼Œç‚¹å‡»éº¦å…‹é£å¼€å§‹";
            }
        });

        conn.on('data', (data) => {
            // Receive data
            if (data.type === 'text') {
                addMessage(data.content, false);
            }
        });
        
        conn.on('close', () => {
            connStatus.textContent = "è¿æ¥æ–­å¼€";
            connStatus.classList.remove('connected');
        });
    }

    // Send data helper
    function sendTextToPeer(text) {
        if (conn && conn.open) {
            conn.send({ type: 'text', content: text });
        }
    }

    // --- Speech Recognition ---
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    
    if (!SpeechRecognition) {
        statusText.textContent = "æµè§ˆå™¨ä¸æ”¯æŒè¯­éŸ³è¯†åˆ«";
        tipsText.textContent = "è¯·ä½¿ç”¨ Chrome, Safari (iOS 14.5+), æˆ– Edge";
        micBtn.classList.add('disabled');
    } else {
        recognition = new SpeechRecognition();
        recognition.lang = 'zh-CN';
        recognition.continuous = true;
        recognition.interimResults = true;

        recognition.onstart = () => {
            isRecording = true;
            micBtn.classList.add('recording');
            statusText.textContent = "æ­£åœ¨è†å¬...";
            // Prevent sleep if possible
            if (navigator.wakeLock) {
                navigator.wakeLock.request('screen').catch(console.error);
            }
        };

        recognition.onend = () => {
            if (isRecording) {
                // Auto restart
                console.log("Recognition ended, restarting...");
                try { recognition.start(); } catch(e) {}
            } else {
                micBtn.classList.remove('recording');
                statusText.textContent = "å·²åœæ­¢";
            }
        };

        recognition.onresult = (event) => {
            let interimTranscript = '';
            let finalSegment = '';

            for (let i = event.resultIndex; i < event.results.length; ++i) {
                if (event.results[i].isFinal) {
                    finalSegment += event.results[i][0].transcript;
                } else {
                    interimTranscript += event.results[i][0].transcript;
                }
            }

            if (finalSegment) {
                // Add to local UI
                addMessage(finalSegment, true);
                // Send to peer
                sendTextToPeer(finalSegment);
            }

            if (interimTranscript) {
                statusText.textContent = "Listening: " + interimTranscript;
            } else {
                statusText.textContent = "æ­£åœ¨è†å¬...";
            }
        };
        
        recognition.onerror = (event) => {
            console.error("Speech Error:", event.error);
            if (event.error === 'not-allowed') {
                statusText.textContent = "è¯·å…è®¸éº¦å…‹é£æƒé™";
                isRecording = false;
                micBtn.classList.remove('recording');
            } else if (event.error === 'no-speech') {
                // Ignore, will restart or continue
            } else {
                statusText.textContent = "è¯†åˆ«é”™è¯¯: " + event.error;
            }
        };
    }

    // --- Event Listeners ---
    micBtn.addEventListener('click', () => {
        if (!recognition) return;
        
        // Haptic feedback
        if (navigator.vibrate) navigator.vibrate(50);

        if (isRecording) {
            isRecording = false;
            recognition.stop();
            micBtn.classList.remove('recording');
            statusText.textContent = "å·²åœæ­¢";
        } else {
            // Check context state if audioContext exists (not used here but good practice)
            try {
                recognition.start();
            } catch(e) {
                recognition.stop(); // Reset
                setTimeout(() => recognition.start(), 200);
            }
        }
    });

    clearBtn.addEventListener('click', () => {
        if(confirm('ç¡®å®šæ¸…ç©ºæ‰€æœ‰è®°å½•å—ï¼Ÿ')) {
            transcriptDiv.innerHTML = '';
            transcriptDiv.appendChild(welcomeMsg);
            // Don't necessarily sync clear, but we could
        }
    });

    // Add Message to UI
    function addMessage(text, isLocal) {
        if (!text.trim()) return;
        
        // Hide welcome message
        welcomeMsg.style.display = 'none';

        const row = document.createElement('div');
        row.className = 'msg-row';

        const msg = document.createElement('div');
        msg.className = 'msg' + (isLocal ? ' local' : '');
        msg.textContent = text;

        const btn = document.createElement('button');
        btn.className = 'copy-btn';
        btn.textContent = 'å¤åˆ¶';
        btn.onclick = () => {
            navigator.clipboard.writeText(text).then(() => {
                btn.textContent = 'å·²å¤åˆ¶';
                setTimeout(() => btn.textContent = 'å¤åˆ¶', 2000);
            });
        };

        row.appendChild(msg);
        row.appendChild(btn);
        transcriptDiv.appendChild(row);
        
        // Auto scroll
        transcriptDiv.scrollTop = transcriptDiv.scrollHeight;
    }

    // QR Code Generation
    qrBtn.onclick = () => {
        const modal = document.getElementById('qr-modal');
        const container = document.getElementById('qrcode');
        
        if (!myPeerId) {
            alert("æ­£åœ¨è¿æ¥åŒæ­¥æœåŠ¡ï¼Œè¯·ç¨å€™...");
            return;
        }

        modal.style.display = 'flex';
        container.innerHTML = '';
        
        // Generate URL with host param
        const baseUrl = window.location.href.split('?')[0];
        const connectionUrl = `${baseUrl}?host=${myPeerId}`;
        
        new QRCode(container, {
            text: connectionUrl,
            width: 200,
            height: 200
        });
    };

    // Initialize
    initPeer();

</script>

</body>
</html>

